#!/bin/bash
# postinst script for linuxmuster-ipfire
#
# thomas@linuxmuster.net
# 27.05.2014
# GPL v3
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#


case "$1" in
    configure)

	 [ -e /usr/share/linuxmuster/config/dist.conf ] && . /usr/share/linuxmuster/config/dist.conf

	 # do nothing if linuxmuster.net ist not yet installed
     [ -e "$INSTALLED" ] || exit 0

     . $HELPERFUNCTIONS
     SETUPSCRIPT="/usr/share/linuxmuster-ipfire/setup.sh"
     MINCORE="77"

     if ! test_pwless_fw; then
      echo "You have to repeat package configuration with"
      echo "# dpkg-reconfigure linuxmuster-ipfire"
      echo "when you have fixed this!"
      exit 0
     fi

	 # test if firewall is IPFire, get current version
	 ipfrel="$CACHEDIR/ipfire-release"
	 if get_ipcop /etc/system-release "$ipfrel"; then
	  curver="$(cat "$ipfrel" | awk '{ print $2 }')"
	  curcore="$(cat "$ipfrel" | awk '{ print $5 }' | sed 's/core//')"
	  echo "IPFire $curver core $curcore detected!"
	  if [ "$curcore" -lt "$MINCORE" ]; then
	   echo "Your current IPFire core update level is less then $MINCORE and therefore not supported. Please upgrade IPFire to core update level $MINCORE!"
	  fi
	 else
	  echo "This is probably not an IPFire firewall!"
	  echo "Don't forget to invoke the setup script"
	  echo "$SETUPSCRIPT"
	  echo "later when IPFire is installed!"
	  exit 0
	 fi

     # update linuxmuster.net scripts on IPFire
     if exec_ipcop /bin/ls /var/linuxmuster; then
      echo -n "Uploading linuxmuster.net configuration scripts to IPFire ... "
      exec_ipcop /bin/rm -rf /var/linuxmuster ; RC="$?"
      echo "$MINCORE" > /var/lib/linuxmuster-ipfire/mincore
      put_ipcop /var/lib/linuxmuster-ipfire /var/linuxmuster ; [ "$?" != "0" ] && RC="$?"
      if [ "$RC" = "0" ]; then
       echo "Ok!"

	   # repair ipfire path in ovpn.cnf (#200)
	   ovpncnf="/var/ipfire/ovpn/openssl/ovpn.cnf"
	   if exec_ipcop /bin/grep -q ipcop "$ovpncnf"; then
	    echo "Fixing ipfire path in ovpn config."
	    exec_ipcop /bin/sed -e "s/ipcop/ipfire/g" -i "$ovpncnf"
	   fi
	   
	   # restarting external firewall
	   echo "Reloading firewall rules ..."
	   $SCRIPTSDIR/internet_on_off.sh || true

      else
       echo "Failed!"
      fi
     else
	  echo "IPFire is not yet configured!"
	  echo "You have to invoke the setup script"
	  echo "$SETUPSCRIPT"
	  echo "to prepare IPFire for use with linuxmuster.net!"
     fi

     ;;

    abort-upgrade|abort-remove|abort-deconfigure)
	 ;;

    *)
     echo "postinst called with unknown argument \`$1'" >&2
     exit 1
     ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
